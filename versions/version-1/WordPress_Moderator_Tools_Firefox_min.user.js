// ==UserScript==
// @name        WordPress Moderator Tools
// @namespace   WordPress_moderator_tools
// @description Adds keyboard shortcut navigation (and more) for WordPress forum moderators.
// @include     *://*wordpress.org/support/bb-admin/posts.php*
// @include     *://*wordpress.org/support/bb-admin/topics.php*
// @include     *://*wordpress.org/support/profile/*
// @include     *://*wordpress.org/support/forum/*
// @include     *://*wordpress.org/support/topic/*
// @version     1
// @grant       none
// ==/UserScript==
(function(z){var P="hide";var h="#e3cebd";var y="#moderator_tools_menu{position:fixed;top:10px;left:65px;background:white;border:3px solid; padding: 0 3em 0 10px;}#moderator_tools_menu a{text-decoration:none}#wordpress-org #moderator_tools_menu{font-size:13px}#wordpress-org #moderator_tools_menu span#close_menu span{display:none; }span#detected span{display:inline-block;margin:5px 0;}   .shortcut{background-color:#cae8f7;padding:1px 3px;display:inline-block;margin-bottom:4px;font-weight:bold}#shortcut_title{display:block;font-weight:bold;margin:1em 0}#wordpress-org #shortcut_title{display:inline}#shortcut_top{margin-bottom:1em}#close_menu{position: absolute; right: 0; top: 5px;padding:0;margin:4px 1em 0 0; }#close_menu a{font-size:1.8em;border:0;}#extra_info_text{margin-right:40px}.edit_profile_link{display:block;margin-top:5px}",O='<span id="shortcut_title">Shortcuts available on this page:</span>',u=z('<span id="shortcuts">(h) </span><a href="#">shortcuts</a>'),C='<span class="shortcut">m</span> - show/hide menu<br/><span class="shortcut">t</span> - go to the top of this page  | <span class="shortcut">b</span> - go to the bottom of this page<br/>',L=z('<span id="close_menu"><a href="#" >&#10006;</a></span>'),T=z('<div id="moderator_tools_menu"></div>'),j,D,V,k,H,I,W,s,g,B,t,e,m,r,U,F=false,i={},a=false,c=false,v=z('<span id="extra_info_text"></span>');function b(){if("hide"===P){T.hide();z("#extra_info_text").text("type m to display menu")}else{if("show"===P){z("#extra_info_text").text("type m to hide menu")}else{P="hide";T.hide();z("#extra_info_text").text("type m to display menu")}}}function N(){if(z("#posts-list").length){a=true;c=true;E("#posts","#post")}if(z("#topics-list").length){a=true;c=true;E("#topics","#topic")}if(!a){if(z(".mod-login").length){c=true;if(z("#profile-form").length){o()}if(z("#user-replies").length||z("#user-threads").length){l()}if(z(".forumlist").length){Q(".widefat")}}if(z("#thread").length){q()}}}function E(Z,d){if(z("moderator_tools_menu").length){return}var X="table.widefat tr.current_post td{border:solid #9f9f9f;border-width:2px 0}table.widefat tr.current_post td.check-column{border-left:2px solid #9f9f9f}table#posts-list tr.current_post td.date,table#topics-list tr.current_post td.freshness{border-right:2px solid #9f9f9f}{border-right:2px solid #9f9f9f}.normal_span,.bozo_span{display:block;margin-top:10px;color:white;text-align:center;background:red}.normal_span{background:green}.profile_type{padding:4px 6px;border:1px solid red}.profile_type.green{border:1px solid green}",Y='<span class="shortcut">h</span> - show/hide shortcuts<br/><span class="shortcut">d</span> - loop through Bulk Actions dropdown options<br/><span class="shortcut">a</span> - select/deselect all posts<br/><span class="shortcut">s</span> - select/deselect current post in new tab<br/><span class="shortcut">e</span> - open user profile current post<br/><span class="shortcut">i</span> - open all <span style="background:'+h+';">selected posts</span> edit profile pages in new tabs. (depending on your browser setting)<br/><span class="shortcut">n</span> - go to the next post | <span class="shortcut">p</span> - go to the previous post<br/><span class="shortcut">z</span> - go to the next normal profile post | <span class="shortcut">x</span> - go to the previous normal profile post<br/><span class="shortcut">shift z</span> - go to the next bozo profile post | <span class="shortcut">shift x</span> - go to the previous bozo profile post<br/><span class="shortcut">mouse click</span> - Click in the "Author" column to select/deselect a post (also sets the post to current)<br/><span class="shortcut">mouse click</span> - Click anywhere in a post to set it to current, for navigation with the shortcuts <span class="shortcut">n</span> and <span class="shortcut">p</span> (see above)';z("head").append('<style type="text/css">'+y+X+"</style>");t='<p id="shortcut_list" style="display: none;">'+O+C+Y+"</p>";T.append(u,L,t);z("body").append(T);z("#bbUserInfo > p").prepend(v);b();e="current_post";m="tr.current_post";r="tr:first";U=z(Z+"-list tbody tr");g=z("#bbHead");B=U.last();V=".check-column > input";D=z("thead tr "+V+",tfoot tr "+V);k=z("td.author");K(d+"-search-form");w(u,L);S();x();p()}function o(){if(z("moderator_tools_menu").length){return}z("head").append('<style type="text/css">'+y+"</style>");var d='<span class="shortcut">n</span> - go to the next section | <span class="shortcut">p</span> - go to the previous section<br/><span class="shortcut">e</span> - refresh profile page<br/><span class="shortcut">r</span> - open bb-admin profile posts in new tab<br/><span class="shortcut">w</span> - remove or add (back) website url<br/><span class="shortcut">z</span> - select/deselect "This user is a bozo" checkbox<br/><span class="shortcut">x</span> - select/deselect "Akismet Never Trust" checkbox<br/>';shortcut_top=z('<p id="shortcut_top">'+O+"</p>");shortcut_top.append(L);t="<p>"+C+d+"</p>";T.append(shortcut_top,t);z("body").append(T);v.insertBefore(z("#profile-form")).wrap("<p></p>");b();H=z("#user_url");I=H.val();W=z("input#is_bozo");s=z("#elf_not_trusted");e="current_section";m="#profile-form h3.current_section";r="h3.section:first";U=z("#profile-form h3");U.addClass("section");z("h3:contains('Mailing Lists')").removeClass("section");z("h3:contains('Administration')").addClass("admin_section");z("label[for='user_url']").append(' <span class="shortcut">(w)</span>');z("label[for='is_bozo']").append(' <span class="shortcut">(z)</span>');z("label[for='elf_not_trusted']").append(' <span class="shortcut">(x)</span>');g=z("#wporg-header");B=z("#wporg-footer");K("#profile-form");f();J();S();x();p()}function l(){if(z("moderator_tools_menu").length){return}z("head").append('<style type="text/css">'+y+"</style>");var d='<span class="shortcut">m</span> - show/hide menu<br/><span class="shortcut">e</span> - open edit profile in new tab<br/><span class="shortcut">r</span> - open bb-admin profile posts in new tab<br/>';shortcut_top=z('<p id="shortcut_top">'+O+"</p>");shortcut_top.append(L);t="<p>"+d+"</p>";T.append(shortcut_top,t);z("body").append(T);var X=z(".topicnav").find("p");X.css("margin","0 0 .5em");v.insertAfter(X).wrap("<p></p>");b();z.each(["#user-replies","#user-threads"],function(Y,Z){Q(Z)});J();p()}function q(){if(z("moderator_tools_menu").length){return}var d=".wpmtprofile_selected {background-color: #efeef5;padding: 3px 6px;margin: 3px 0;display: inline-block;}";z("head").append('<style type="text/css">'+y+d+"</style>");var Y='<span class="shortcut">e</span> - go to current post profile page<br/><span class="shortcut">n</span> - go to the next section | <span class="shortcut">p</span> - go to the previous section<br/><span class="shortcut">mouse click</span> - Click anywhere in a post to set it to current, for navigation with the shortcuts <span class="shortcut">n</span> and <span class="shortcut">p</span> (see above)';shortcut_top=z('<p id="shortcut_top">'+O+"</p>");shortcut_top.append(L);t="<p>"+C+Y+"</p>";T.append(shortcut_top,t);z("body").append(T);var X=z(".topicnav").find("p");X.css("margin","0 0 .5em");v.insertAfter(X).wrap("<p></p>");b();e="current_post";m="li.current_post";r="li:first";U=z(".postitem");K("#postform");K("#head-search > form");K("#tag-form");g=z("#wporg-header");B=U.last();S();n();x();p()}function f(){z("html").bind("keydown.wpmt",function(aa){if(F!==false){return}var d=G(aa);if((87===aa.keyCode)&&(1===d)){if(H.length==1){z(m).removeClass(e);var Z=U.first();Z.addClass(e);R(Z);if(I){if(""===H.val()){H.val(I)}else{H.val("")}clearTimeout(Y);H.parents("tr").css("background-color","#FFFFCC");var Y=setTimeout(function(){H.parents("tr").css("background-color","#FFFFFF")},300)}}}if((aa.keyCode===90||aa.keyCode===88)&&(d===1)){var X=(aa.keyCode===90)?W:s;if(X){R(z("h3.admin_section"));if(X.attr("checked")){X.removeAttr("checked")}else{X.click()}clearTimeout(ab);X.parents("tr").css("background-color","#FFFFCC");var ab=setTimeout(function(){X.parents("tr").css("background-color","#FFFFFF")},300)}}})}function n(){U.bind("click.wpmt",function(Y){if(Y.target.nodeName!="A"){d();M();z(this).addClass(e);var X=z(this).find(".authortitle a");if(X.length){X.addClass("wpmtprofile_selected")}}});z("html").bind("keydown.wpmt",function(aa){if(F!==false){return}var Y=G(aa);var Z=z(m);if(Z.length){d();var X=z(Z).find(".authortitle a");if(X.length){X.addClass("wpmtprofile_selected");if((aa.keyCode===69)&&(Y=1)){A(X.attr("href"))}}}else{d()}});function d(){z(".authortitle > a",U).removeClass("wpmtprofile_selected")}}function w(d,Z){X();z("html").bind("keydown.wpmt",function(ah){if(F!==false){return}var ag=G(ah);if((ah.keyCode===83)&&(ag===1)){ai=z(m);if(ai.length==1){R(ai);var ac=ai.find(V);ac.attr("checked",!ac.attr("checked"));X()}}if((ah.keyCode===68)&&(ag===1)){z(".bulk-form select[name=action] > option:selected").removeAttr("selected").next("option").attr("selected","selected")}if((ah.keyCode===65)&&(ag===1)){j=(D.attr("checked"))?"off":"on";Y()}if((ah.keyCode===72)&&(ag===1)){z("#shortcut_list").toggle()}if((ah.keyCode===73)&&(ag===1)){var aj=[];z(".post_selected").each(function(){var al=z(this).children().first("a").attr("href");if(aj.indexOf(al)==-1){aj.push(al);A(al+"/edit")}})}if((ah.keyCode===69)&&(ag===1)){ai=z(m);if(ai.length==1){var ab=ai.find(".edit_profile_link > a").attr("href");if(ab.length){A(ab)}}}if(U.length>=1){var ai;if(i.hasOwnProperty(90)||i.hasOwnProperty(88)){var ae=(i.hasOwnProperty(16)&&(ag===2))?"bozo":"normal";if(ae=="bozo"){U.removeClass("current_normal_post")}else{U.removeClass("current_bozo_post")}var ak=i.hasOwnProperty(90)?"z":"x",ad=z("."+ae+"_post");if(ad.length){if(z(".current_"+ae+"_post").length===0){ai=(ak=="z")?ad.first():ad.last();U.removeClass(e);ai.addClass("current_"+ae+"_post "+e);R(ai)}else{if(ad.length==1){var af=ad.first();U.removeClass(e);af.addClass(e);R(af)}else{var aa;ai=z(".current_"+ae+"_post");if(ak=="z"){aa=ai.nextAll("."+ae+"_post:first")}if(ak=="x"){aa=ai.prevAll("."+ae+"_post:first")}if(aa.length){U.removeClass(e);ai.removeClass("current_"+ae+"_post");aa.addClass("current_"+ae+"_post "+e);R(aa)}}}}}}});z(D).bind("click.wpmt",function(){j=(z(this).attr("checked"))?"on":"off";Y()});U.bind("click.wpmt",function(aa){if(aa.target.nodeName!="A"){z("tbody tr").removeClass(e);z(this).addClass(e)}});z("tbody > tr > "+V).bind("click.wpmt",function(aa){X()});k.bind("click.wpmt",function(aa){if(aa.target.nodeName!="A"){X(z(this).parent().attr("id"))}});d.bind("click.wpmt",function(aa){aa.preventDefault();z("#shortcut_list").toggle()});function Y(){k.each(function(){var aa=z(this).parent().find(V);if(j=="on"){aa.attr("checked",true)}else{aa.attr("checked",false)}});X();j=false}function X(ah){T.children("#detected").remove();var ad=0,ag=0,ac=0,af=0,ae=false;k.each(function(){var an=z(this).parent().children(".check-column").css("background-color"),am=z(this).parent().attr("class"),ak=z.trim(z(this).children().first("a").text()),al=z(this).parent().find(V);z(this).css("background",an);if(z(this).children(".edit_profile_link").length===0){var aj=z("img",z(this).children().first("a")),ai='<br/><span class="edit_profile_link"><a href="'+z(this).children().first("a").attr("href")+'/edit">Edit Profile</a></span>';if(ak.indexOf("(BOZO)")>=0){ak=z.trim(ak.replace("(BOZO)",""));z(this).children().first("a").text(" "+ak);if(aj){z(this).children().first("a").prepend(aj)}z(this).append('<span class="bozo_span" >BOZO</span>');z(this).parent().addClass("bozo_post");++ag}else{z(this).parent().addClass("normal_post")}z(this).children().first("a").after(ai)}else{if(z(this).children("span.bozo_span").length){++ag}else{z(this).parent().addClass("normal_post")}}if(al.attr("checked")){z(this).attr("style","background: "+h+";");z(this).addClass("post_selected")}else{z(this).css("background",an);z(this).removeClass("post_selected")}if((typeof(ah)!=="undefined")&&(ah==z(this).parent().attr("id"))){if(al.attr("checked")){z(this).css("background",an);al.attr("checked",false);z(this).removeClass("post_selected")}else{z(this).attr("style","background: "+h+";");al.attr("checked",true);z(this).addClass("post_selected")}}});var ab=z("tbody > tr").length;ac=z("tbody > tr > "+V+":checked").length;if(ac<ab){z(D).attr("checked",false)}if(ac==ab){z(D).attr("checked",true)}var aa="";aa+="Current Page: "+ab+" post"+((ab==1)?"":"s");aa+=' &#10022; <span class="profile_type">';aa+=(ag>0)?ag+" bozo"+((ag==1)?"":"s"):"no bozos";aa+="</span>";aa+=' &#10022; <span class="profile_type green">';aa+=(ab-ag>0)?(ab-ag)+" normal profile"+(((ab-ag)==1)?"":"s"):"no normal profiles";aa+="</span>";aa+=' | <span style="background-color: '+h+'; padding: 5px 7px;">';aa+=(ac>0)?ac+" post"+((ac==1)?"":"s")+" selected":"No posts selected";aa+="</span> | ";T.children("#shortcuts").before('<span id="detected" style="padding-bottom: 1em;">'+aa+"</span>")}}function J(){var ab=z("#profile-menu");var aa;var X;var Z;if(z(ab).length){aa=ab.find("a").filter(function(ac){return z(this).text()==="Edit"})}if(z(aa).length){z(aa).text("Edit (e)");X=z(aa).attr("href");var d=z("#userlogin");if(d.length){Z="http://wordpress.org/support/bb-admin/posts.php?forum_id=0&post_author="+z(d).text();var Y=z('<li><a href="'+Z+'" rek="_blank">bb-admin (r)</a></li>');z(aa).parent().after(Y)}}if((X.length)||(Z.length)){z("html").bind("keydown.wpmt",function(ad){if(F!==false){return}var ac=G(ad);if((ad.keyCode===69)&&(X.length)){if(ac===1){if(z("#profile-form").length){location.reload(true)}else{A(X+"/edit")}}}if((ad.keyCode===82)&&(Z.length)){if(ac===1){A(Z)}}})}}function S(){var d;z("html").bind("keydown.wpmt",function(Z){if(F!==false||(typeof(U)==="undefined")){return}var Y=G(Z);if(Z.keyCode===78||Z.keyCode===80){var X=Z.keyCode===78?"n":"p";U.removeClass("current_normal_post current_bozo_post");if(z(m).length===0){if((X=="n")&&(Y===1)){d=U.first();R(d);d.addClass(e)}}else{d=z(m);if((X=="n")&&(Y===1)){if(d.nextAll(r).length){d.removeClass(e).nextAll(r).addClass(e);R(z(m))}else{R(z(m))}}if((X=="p")&&(Y===1)){if(d.prevAll(r).length){d.removeClass(e).prevAll(r).addClass(e);R(z(m))}else{d.removeClass(e);R(g)}}}}})}function x(){z("html").bind("keydown.wpmt",function(Y){if(F!==false){return}var d=G(Y);if((Y.keyCode===84)&&(d===1)){if(g.length){R(g);if(typeof(U)!=="undefined"){M()}}}if((Y.keyCode===66)&&(d===1)){if(B.length){R(B);if(typeof(U)!=="undefined"){M();var X=U.last();X.addClass(e)}}}})}function p(){L.bind("click.wpmt",function(Y){Y.preventDefault();T.toggle();z("#shortcut_list").hide();var d=(T.is(":visible"))?"hide":"display";v.text("type m to "+d+" menu");var X=z(m);if(X.length){R(X)}});z("html").bind("keydown.wpmt",function(Z){if(F!==false){return}var X=G(Z);if((Z.keyCode===77)&&(X===1)){T.toggle();z("#shortcut_list").hide();var d=(T.is(":visible"))?"hide":"display";z("#extra_info_text").text("type m to "+d+" menu");var Y=z(m);if(Y.length){R(Y)}}})}function R(d){var X=d.offset().top;if(z(d).height()+65>z(window).height()){X=X-((z("#moderator_tools_menu").is(":visible"))?65:5)}else{X=X-65}z("html, body").animate({scrollTop:X},{duration:150})}function M(){if(z(U).length){U.removeClass("current_post current_normal_post current_bozo_post current_section")}}function K(d){el=z(d);if(el.length){el.focusin(function(){F=true}).focusout(function(){F=false})}}function G(d){i[d.which]=true;return Object.keys(i).length}function A(d){setTimeout(function(){window.open(d,"_blank")},200)}z(document).bind("keyup.wpmt",function(d){delete i[d.which]});function Q(d){var X=z(d).find("a");if(z(X).length){z(X).attr("href",function(){var Z=this.search;var Y=this.protocol+"//"+this.host+this.pathname;var aa=false;if(Z){var ab=/view=all/g;if(!ab.test(Z)){aa=Y+Z+"&view=all"}}else{aa=Y+"?view=all"}if(aa){return aa+this.hash}return this})}}N()})(jQuery);