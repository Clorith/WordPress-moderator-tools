// ==UserScript==
// @name        WordPress Moderator Tools
// @namespace   WordPress_moderator_tools
// @description Adds keyboard shortcut navigation (and more) for WordPress forum moderators.
// @include     *://*wordpress.org/support/bb-admin/posts.php*
// @include     *://*wordpress.org/support/bb-admin/topics.php*
// @include     *://*wordpress.org/support/profile/*
// @include     *://*wordpress.org/support/forum/*
// @include     *://*wordpress.org/support/topic/*
// @include     *://*wordpress.org/support/edit.php?id=*
// @version     2
// @grant       none
// ==/UserScript==
function moderator_tools_with_jquery(b){var a=document.createElement("script");a.type="text/javascript";a.textContent="("+b.toString()+")(jQuery)";document.body.appendChild(a)}moderator_tools_with_jquery(function(A){var R="hide";var h="#e3cebd";var z="#moderator_tools_menu{position:fixed;top:10px;left:65px;background:white;border:3px solid; padding: 0 3em 0 10px;}#moderator_tools_menu a{text-decoration:none}#wordpress-org #moderator_tools_menu{font-size:13px}#wordpress-org #moderator_tools_menu span#close_menu span{display:none; }span#detected span{display:inline-block;margin:5px 0;}   .shortcut{background-color:#cae8f7;padding:1px 3px;display:inline-block;margin-bottom:4px;font-weight:bold}#shortcut_title{display:block;font-weight:bold;margin:1em 0}#wordpress-org #shortcut_title{display:inline}#shortcut_top{margin-bottom:1em}#close_menu{position: absolute; right: 0; top: 5px;padding:0;margin:4px 1em 0 0; }#close_menu a{font-size:1.8em;border:0;}#extra_info_text{margin-right:40px}.edit_profile_link{display:block;margin-top:5px}",Q='<span id="shortcut_title">Shortcuts available for this page:</span>',v=A('<span id="shortcuts">(h) </span><a href="#">shortcuts</a>'),D='<span class="shortcut">m</span> - show/hide menu<br/><span class="shortcut">t</span> - go to the top of this page  | <span class="shortcut">b</span> - go to the bottom of this page<br/>',N=A('<span id="close_menu"><a href="#" >&#10006;</a></span>'),V=A('<div id="moderator_tools_menu"></div>'),k,E,X,l,M=false,I,J,Y,t,g,C,u,e,n,s,W,G=false,i={},a=false,c=false,w=A('<span id="extra_info_text"></span>');function b(){if("hide"===R){V.hide();A("#extra_info_text").text("type m to display menu")}else{if("show"===R){A("#extra_info_text").text("type m to hide menu")}else{R="hide";V.hide();A("#extra_info_text").text("type m to display menu")}}}function P(){if(A("#moderator_tools_menu").length||A("#moderator_tools_ed_uncap").length){return}if(A("#posts-list").length){a=true;c=true;F("#posts","#post")}if(A("#topics-list").length){M=true;a=true;c=true;F("#topics","#topic")}if(!a){if(A(".mod-login").length){c=true;if(A("#profile-form").length){p()}if(A("#user-replies").length||A("#user-threads").length){m()}if(A(".edit-form").length){j()}if(A(".forumlist").length){S(".widefat")}}if(A("#thread").length){r()}}}function j(){var ac=0,d=0,aa=0;var ab=A("#ed_toolbar");if(ab.length){var Z=A('<input id="moderator_tools_ed_uncap" class="moderator_tools_ed_button" type="button" value="l-case" accesskey="d">');ab.append(Z);A("#post_content").add(A("#topic")).select(function(ad){ac=ad.target.selectionStart;d=ad.target.selectionEnd;aa=A(this)});Z.bind("click.wpmt",function(ag){ag.preventDefault();if(aa){var af=aa.val().substring(ac,d).toLowerCase();var ad=aa.val().substring(0,ac)+af+aa.val().substring(d);aa.val(ad);aa.focus();var ae=aa.get(0);ae.selectionStart=d;ae.selectionEnd=d}ac=d=aa=0})}}function F(ab,d){var Z="table.widefat tr.current_post td{border:solid #9f9f9f;border-width:2px 0}table.widefat tr.current_post td.check-column{border-left:2px solid #9f9f9f}table#posts-list tr.current_post td.date,table#topics-list tr.current_post td.freshness{border-right:2px solid #9f9f9f}{border-right:2px solid #9f9f9f}.normal_span,.bozo_span{display:block;margin-top:10px;color:white;text-align:center;background:red}.normal_span{background:green}.profile_type{padding:4px 6px;border:1px solid red}.profile_type.green{border:1px solid green}",aa='<span class="shortcut">h</span> - show/hide shortcuts<br/><span class="shortcut">d</span> - loop through Bulk Actions dropdown options<br/><span class="shortcut">a</span> - select/deselect all posts<br/><span class="shortcut">s</span> - select/deselect current post<br/><span class="shortcut">e</span> - edit the user profile from the current post in a new tab. (depending on your browser setting)<br/><span class="shortcut">i</span> - edit all <span style="background:'+h+';">selected posts</span> user profiles in new tabs. (depending on your browser setting)<br/><span class="shortcut">n</span> - go to the next post | <span class="shortcut">p</span> - go to the previous post<br/>';if(!M){aa+='<span class="shortcut">z</span> - go to the next normal profile post | <span class="shortcut">x</span> - go to the previous normal profile post<br/><span class="shortcut">shift z</span> - go to the next bozo profile post | <span class="shortcut">shift x</span> - go to the previous bozo profile post<br/>'}aa+='<span class="shortcut">mouse click</span> - Click in the "Author" column to select/deselect a post (also sets the post to current)<br/><span class="shortcut">mouse click</span> - Click anywhere in a post to set it to current, for navigation with the shortcuts <span class="shortcut">n</span> and <span class="shortcut">p</span> (see above)';A("head").append('<style type="text/css">'+z+Z+"</style>");u='<p id="shortcut_list" style="display: none;">'+Q+D+aa+"</p>";V.append(v,N,u);A("body").append(V);A("#bbUserInfo > p").prepend(w);b();e="current_post";n="tr.current_post";s="tr:first";W=A(ab+"-list tbody tr");g=A("#bbHead");C=W.last();X=".check-column > input";E=A("thead tr "+X+",tfoot tr "+X);l=A("td.author");L(d+"-search-form");x(v,N);U();y();q()}function p(){A("head").append('<style type="text/css">'+z+"</style>");var d='<span class="shortcut">n</span> - go to the next section | <span class="shortcut">p</span> - go to the previous section<br/><span class="shortcut">e</span> - refresh profile page<br/><span class="shortcut">r</span> - open bb-admin profile posts in new tab<br/><span class="shortcut">w</span> - remove or add (back) website url<br/><span class="shortcut">z</span> - select/deselect "This user is a bozo" checkbox<br/><span class="shortcut">x</span> - select/deselect "Akismet Never Trust" checkbox<br/>';shortcut_top=A('<p id="shortcut_top">'+Q+"</p>");shortcut_top.append(N);u="<p>"+D+d+"</p>";V.append(shortcut_top,u);A("body").append(V);w.insertBefore(A("#profile-form")).wrap("<p></p>");b();I=A("#user_url");J=I.val();Y=A("input#is_bozo");t=A("#elf_not_trusted");e="current_section";n="#profile-form h3.current_section";s="h3.section:first";W=A("#profile-form h3");W.addClass("section");A("h3:contains('Mailing Lists')").removeClass("section");A("h3:contains('Administration')").addClass("admin_section");A("label[for='user_url']").append(' <span class="shortcut">(w)</span>');A("label[for='is_bozo']").append(' <span class="shortcut">(z)</span>');A("label[for='elf_not_trusted']").append(' <span class="shortcut">(x)</span>');g=A("#wporg-header");C=A("#wporg-footer");L("#profile-form");f();K();U();y();q()}function m(){A("head").append('<style type="text/css">'+z+"</style>");var d='<span class="shortcut">m</span> - show/hide menu<br/><span class="shortcut">e</span> - open edit profile in new tab<br/><span class="shortcut">r</span> - open bb-admin profile posts in new tab<br/>';shortcut_top=A('<p id="shortcut_top">'+Q+"</p>");shortcut_top.append(N);u="<p>"+d+"</p>";V.append(shortcut_top,u);A("body").append(V);var Z=A(".topicnav").find("p");Z.css("margin","0 0 .5em");w.insertAfter(Z).wrap("<p></p>");b();A.each(["#user-replies","#user-threads"],function(aa,ab){S(ab)});K();q()}function r(){var d=".wpmtprofile_selected {background-color: #efeef5;padding: 3px 6px;margin: 3px 0;display: inline-block;}.ip-warning{color:red;}";A("head").append('<style type="text/css">'+z+d+"</style>");var aa='<span class="shortcut">e</span> - go to current post profile page<br/><span class="shortcut">n</span> - go to the next section | <span class="shortcut">p</span> - go to the previous section<br/><span class="shortcut">mouse click</span> - Click anywhere in a post to set it to current, for navigation with the shortcuts <span class="shortcut">n</span> and <span class="shortcut">p</span> (see above)';shortcut_top=A('<p id="shortcut_top">'+Q+"</p>");shortcut_top.append(N);u="<p>"+D+aa+"</p>";V.append(shortcut_top,u);A("body").append(V);var Z=A(".topicnav").find("p");Z.css("margin","0 0 .5em");w.insertAfter(Z).wrap("<p></p>");b();e="current_post";n="li.current_post";s="li:first";W=A(".postitem");L("#postform");L("#head-search > form");L("#tag-form");g=A("#wporg-header");C=W.last();U();o();y();q()}function f(){A("html").bind("keydown.wpmt",function(ac){if(G!==false){return}var d=H(ac);if((87===ac.keyCode)&&(1===d)){if(I.length==1){A(n).removeClass(e);var ab=W.first();ab.addClass(e);T(ab);if(J){if(""===I.val()){I.val(J)}else{I.val("")}clearTimeout(aa);I.parents("tr").css("background-color","#FFFFCC");var aa=setTimeout(function(){I.parents("tr").css("background-color","#FFFFFF")},300)}}}if((ac.keyCode===90||ac.keyCode===88)&&(d===1)){var Z=(ac.keyCode===90)?Y:t;if(Z){T(A("h3.admin_section"));if(Z.attr("checked")){Z.removeAttr("checked")}else{Z.click()}clearTimeout(ad);Z.parents("tr").css("background-color","#FFFFCC");var ad=setTimeout(function(){Z.parents("tr").css("background-color","#FFFFFF")},300)}}})}function o(){Z();function Z(){var ac=W;var ab={};var ad={};var aa={};ac=ac.filter(function(){var ae=A(this).find(".threadauthor > p > strong").text();if(ab[ae]){return false}else{ab[ae]=true;return true}});A.each(ac,function(ae,af){var ag=A(this).find(".post-ip-link").text();if(ag.length){if(ad[ag]){aa[ag]=true}else{ad[ag]=true}}});if(!A(aa).length){return}W.each(function(){var af=A(this).find(".post-ip-link");if(af.length){var ae=af.text();if(aa[ae]){af.before(A('<span class="ip-warning">(DUPLICATE IP)</span><br />'))}}})}W.bind("click.wpmt",function(ab){if(ab.target.nodeName!="A"){d();O();A(this).addClass(e);var aa=A(this).find(".authortitle a");if(aa.length){aa.addClass("wpmtprofile_selected")}}});A("html").bind("keydown.wpmt",function(ad){if(G!==false){return}var ab=H(ad);var ac=A(n);if(ac.length){d();var aa=A(ac).find(".authortitle a");if(aa.length){aa.addClass("wpmtprofile_selected");if((ad.keyCode===69)&&(ab=1)){B(aa.attr("href"))}}}else{d()}});function d(){A(".authortitle > a",W).removeClass("wpmtprofile_selected")}}function x(d,ab){Z();A("html").bind("keydown.wpmt",function(aj){if(G!==false){return}var ai=H(aj);var ak;if((aj.keyCode===83)&&(ai===1)){ak=A(n);if(ak.length==1){T(ak);var ae=ak.find(X);ae.attr("checked",!ae.attr("checked"));Z()}}if((aj.keyCode===68)&&(ai===1)){A(".bulk-form select[name=action] > option:selected").removeAttr("selected").next("option").attr("selected","selected")}if((aj.keyCode===65)&&(ai===1)){k=(E.attr("checked"))?"off":"on";aa()}if((aj.keyCode===72)&&(ai===1)){A("#shortcut_list").toggle();ak=A(n);if(ak.length){T(ak)}}if((aj.keyCode===73)&&(ai===1)){var al=[];A(".post_selected").each(function(){var an=A(this).children().first("a").attr("href");if(al.indexOf(an)==-1){al.push(an);B(an+"/edit")}})}if((aj.keyCode===69)&&(ai===1)){ak=A(n);if(ak.length==1){var ad=ak.find(".edit_profile_link > a").attr("href");if(ad.length){B(ad)}}}if(!M&&(W.length>=1)){if(i.hasOwnProperty(90)||i.hasOwnProperty(88)){var ag=(i.hasOwnProperty(16)&&(ai===2))?"bozo":"normal";if(ag=="bozo"){W.removeClass("current_normal_post")}else{W.removeClass("current_bozo_post")}var am=i.hasOwnProperty(90)?"z":"x",af=A("."+ag+"_post");if(af.length){if(A(".current_"+ag+"_post").length===0){ak=(am=="z")?af.first():af.last();W.removeClass(e);ak.addClass("current_"+ag+"_post "+e);T(ak)}else{if(af.length==1){var ah=af.first();W.removeClass(e);ah.addClass(e);T(ah)}else{var ac;ak=A(".current_"+ag+"_post");if(am=="z"){ac=ak.nextAll("."+ag+"_post:first")}if(am=="x"){ac=ak.prevAll("."+ag+"_post:first")}if(ac.length){W.removeClass(e);ak.removeClass("current_"+ag+"_post");ac.addClass("current_"+ag+"_post "+e);T(ac)}}}}}}});A(E).bind("click.wpmt",function(){k=(A(this).attr("checked"))?"on":"off";aa()});W.bind("click.wpmt",function(ac){if(ac.target.nodeName!="A"){A("tbody tr").removeClass(e);A(this).addClass(e)}});A("tbody > tr > "+X).bind("click.wpmt",function(ac){Z()});l.bind("click.wpmt",function(ac){if(ac.target.nodeName!="A"){Z(A(this).parent().attr("id"))}});d.bind("click.wpmt",function(ac){ac.preventDefault();A("#shortcut_list").toggle()});function aa(){l.each(function(){var ac=A(this).parent().find(X);if(k=="on"){ac.attr("checked",true)}else{ac.attr("checked",false)}});Z();k=false}function Z(ag){V.children("#detected").remove();var aj=0,ae=0,af=0,ah=0,ad=false;l.each(function(){var aq=A(this).parent().children(".check-column").css("background-color"),ap=A(this).parent().attr("class"),an=A.trim(A(this).children().first("a").text()),ao=A(this).parent().find(X);A(this).css("background",aq);if(A(this).children(".edit_profile_link").length===0){var am=A("img",A(this).children().first("a")),al='<br/><span class="edit_profile_link"><a href="'+A(this).children().first("a").attr("href")+'/edit">Edit Profile</a></span>';if(an.indexOf("(BOZO)")>=0){an=A.trim(an.replace("(BOZO)",""));A(this).children().first("a").text(" "+an);if(am){A(this).children().first("a").prepend(am)}A(this).append('<span class="bozo_span" >BOZO</span>');A(this).parent().addClass("bozo_post");++ae}else{A(this).parent().addClass("normal_post")}A(this).children().first("a").after(al)}else{if(A(this).children("span.bozo_span").length){++ae}else{A(this).parent().addClass("normal_post")}}if(ao.attr("checked")){A(this).attr("style","background: "+h+";");A(this).addClass("post_selected")}else{A(this).css("background",aq);A(this).removeClass("post_selected")}if((typeof(ag)!=="undefined")&&(ag==A(this).parent().attr("id"))){if(ao.attr("checked")){A(this).css("background",aq);ao.attr("checked",false);A(this).removeClass("post_selected")}else{A(this).attr("style","background: "+h+";");ao.attr("checked",true);A(this).addClass("post_selected")}}});var ac=A("tbody > tr").length;af=A("tbody > tr > "+X+":checked").length;if(af<ac){A(E).attr("checked",false)}if(af==ac){A(E).attr("checked",true)}var ak="";var ai=(M)?"topic":"post";ak+="Current Page: "+ac+" "+ai+((ac==1)?"":"s");if(!M){ak+=' &#10022; <span class="profile_type">';ak+=(ae>0)?ae+" bozo"+((ae==1)?"":"s"):"0 bozos";ak+="</span>";ak+=' &#10022; <span class="profile_type green">';ak+=(ac-ae>0)?(ac-ae)+" normal profile"+(((ac-ae)==1)?"":"s"):"no normal profiles";ak+="</span>"}ak+=' | <span style="background-color: '+h+'; padding: 5px 7px;">';ak+=(af>0)?af+" "+ai+((af==1)?"":"s")+" selected":"No "+ai+"s selected";ak+="</span> | ";V.children("#shortcuts").before('<span id="detected" style="padding-bottom: 1em;">'+ak+"</span>")}}function K(){var ad=A("#profile-menu");var ac;var Z;var ab;if(A(ad).length){ac=ad.find("a").filter(function(ae){return A(this).text()==="Edit"})}if(A(ac).length){A(ac).text("Edit (e)");Z=A(ac).attr("href");var d=A("#userlogin");if(d.length){ab="http://wordpress.org/support/bb-admin/posts.php?forum_id=0&post_author="+A(d).text();var aa=A('<li><a href="'+ab+'" rek="_blank">bb-admin (r)</a></li>');A(ac).parent().after(aa)}}if((Z.length)||(ab.length)){A("html").bind("keydown.wpmt",function(af){if(G!==false){return}var ae=H(af);if((af.keyCode===69)&&(Z.length)){if(ae===1){if(A("#profile-form").length){location.reload(true)}else{B(Z+"/edit")}}}if((af.keyCode===82)&&(ab.length)){if(ae===1){B(ab)}}})}}function U(){var d;A("html").bind("keydown.wpmt",function(ab){if(G!==false||(typeof(W)==="undefined")){return}var aa=H(ab);if(ab.keyCode===78||ab.keyCode===80){var Z=ab.keyCode===78?"n":"p";W.removeClass("current_normal_post current_bozo_post");if(A(n).length===0){if((Z=="n")&&(aa===1)){d=W.first();T(d);d.addClass(e)}}else{d=A(n);if((Z=="n")&&(aa===1)){if(d.nextAll(s).length){d.removeClass(e).nextAll(s).addClass(e);T(A(n))}else{T(A(n))}}if((Z=="p")&&(aa===1)){if(d.prevAll(s).length){d.removeClass(e).prevAll(s).addClass(e);T(A(n))}else{d.removeClass(e);T(g)}}}}})}function y(){A("html").bind("keydown.wpmt",function(aa){if(G!==false){return}var d=H(aa);if((aa.keyCode===84)&&(d===1)){if(g.length){T(g);if(typeof(W)!=="undefined"){O()}}}if((aa.keyCode===66)&&(d===1)){if(C.length){T(C);if(typeof(W)!=="undefined"){O();var Z=W.last();Z.addClass(e)}}}})}function q(){N.bind("click.wpmt",function(aa){aa.preventDefault();V.toggle();A("#shortcut_list").hide();var d=(V.is(":visible"))?"hide":"display";w.text("type m to "+d+" menu");var Z=A(n);if(Z.length){T(Z)}});A("html").bind("keydown.wpmt",function(ab){if(G!==false){return}var Z=H(ab);if((ab.keyCode===77)&&(Z===1)){V.toggle();A("#shortcut_list").hide();var d=(V.is(":visible"))?"hide":"display";A("#extra_info_text").text("type m to "+d+" menu");var aa=A(n);if(aa.length){T(aa)}}})}function T(Z){var ab=Z.offset().top;var d=65;var aa=A("#moderator_tools_menu");if(aa.length){if(aa.is(":visible")){d=aa.height();d+=30}else{if((A(Z).height()+d)>A(window).height()){d=5}}}ab=ab-d;A("html, body").animate({scrollTop:ab},{duration:150})}function O(){if(A(W).length){W.removeClass("current_post current_normal_post current_bozo_post current_section")}}function L(d){el=A(d);if(el.length){el.focusin(function(){G=true}).focusout(function(){G=false})}}function H(d){i[d.which]=true;return Object.keys(i).length}function B(d){setTimeout(function(){window.open(d,"_blank")},200)}A(document).bind("keyup.wpmt",function(d){delete i[d.which]});function S(d){var Z=A(d).find("a");if(A(Z).length){A(Z).attr("href",function(){var ab=this.search;var aa=this.protocol+"//"+this.host+this.pathname;var ac=false;if(ab){var ad=/view=all/g;if(!ad.test(ab)){ac=aa+ab+"&view=all"}}else{ac=aa+"?view=all"}if(ac){return ac+this.hash}return this})}}P()});