// ==UserScript==
// @name        WordPress Moderator Tools
// @namespace   WordPress_moderator_tools
// @description Adds keyboard shortcut navigation (and more) for WordPress forum moderators.
// @include     *://*wordpress.org/support/bb-admin/posts.php*
// @include     *://*wordpress.org/support/bb-admin/topics.php*
// @include     *://*wordpress.org/support/profile/*
// @include     *://*wordpress.org/support/forum/*
// @include     *://*wordpress.org/support/topic/*
// @include     *://*wordpress.org/support/edit.php?id=*
// @include     *://*wordpress.org/tags/modlook
// @version     3
// @grant       none
// ==/UserScript==

function moderator_tools_with_jquery(b){var a=document.createElement("script");a.type="text/javascript";a.textContent="("+b.toString()+")(jQuery)";document.body.appendChild(a)}moderator_tools_with_jquery(function(D){var O="hide";var j="#e3cebd";var C="#moderator_tools_menu{position:fixed;top:10px;left:65px;background:white;border:3px solid #333333; color:#333333; padding: 0 3em 0 10px;}#moderator_tools_menu a{text-decoration:none;border:none;}#moderator_tools_menu a:hover{color:#d54e21;}#wordpress-org #moderator_tools_menu{font-size:13px}#wordpress-org #moderator_tools_menu .wpmt_close_menu span{display:none; }.wpmt_stats{padding-bottom:1em;}.wpmt_stats span{display:inline-block;margin:5px 0;}.wpmt_shortcuts_help{margin-left:5px;} .wpmt_shortcut{background-color:#cae8f7;padding:1px 3px;display:inline-block;margin-bottom:4px;font-weight:bold}.wpmt_shortcuts_title{display:block;font-weight:bold;margin:1em 0}#wordpress-org .wpmt_shortcuts_title{display:inline}.wpmt_shortcuts_top{margin-bottom:1em}.wpmt_close_menu{position: absolute; right: 0; top: 5px;padding:0;margin:4px 1em 0 0; }.wpmt_close_menu a{font-size:1.8em;border:0;}.wpmt_is_admin .wpmt_close_menu a{font-size:1.5em;}.wpmt_menu_state{margin-right:40px}.wpmt_profile_edit{display:block;margin-top:5px}.wpmt_modlook{background-color:#efeef5;margin-left:.5em;padding:1px 2px;}",f="wpmt_current",T="https://wordpress.org/support/bb-admin",y='<span class="wpmt_shortcuts_title">Shortcuts available for this page:</span>',n="%m% - show/hide menu<br/>%t% - go to the top of this page  | %b% - go to the bottom of this page<br/>",d="%n% - go to the next post | %p% - go to the previous post<br/>",i="%mouse click% - Click anywhere in a post to set it to current, for navigation with the shortcuts %n% and %p% (see above)",x="%r% - open the user's bb-admin posts page in a new tab<br/>",b=D('<div id="moderator_tools_menu"></div>'),u=D('<span class="wpmt_close_menu"><a href="#" >&times;</a></span>'),z=D('<span class="wpmt_menu_state"></span>'),L=D('<p class="wpmt_shortcuts_top"></p>'),k={},H=false,a=false,e=false,h,F,o,w,S;function N(){if(s(D("#moderator_tools_menu"))||s(D("#moderator_tools_ed_uncap"))){return}if(s(D("#posts-list"))){a=true;e=true;G("posts")}if(s(D("#topics-list"))){a=true;e=true;G("topics")}if(!a){var U=D(".mod-login");if(s(U)){e=true;D("head").append('<style type="text/css">#headline .login{text-align:right;}</style>');U.append(' | <a href="'+T+'/posts.php?forum_id=0&post_status=2">Spam Queue</a> | <a href="https://wordpress.org/tags/modlook">Modlook</a>');if(s(D("#profile-form"))){p()}if(s(D(".edit-form"))){l()}if(s(D(".forumlist"))){P(".widefat")}}if(s(D("#user-replies"))||s(D("#user-threads"))){m()}if(s(D("#thread"))){t()}}else{b.addClass("wpmt_is_admin")}}function l(){var Y=0,U=0,W=0;var X=D("#ed_toolbar");if(s(X)){var V=D('<input id="moderator_tools_ed_uncap" class="moderator_tools_ed_button" type="button" value="l-case" accesskey="d">');X.append(V);D("#post_content").add(D("#topic")).select(function(Z){Y=Z.target.selectionStart;U=Z.target.selectionEnd;W=D(this)});V.bind("click.wpmt",function(ac){ac.preventDefault();if(W){var ab=W.val().substring(Y,U).toLowerCase();var Z=W.val().substring(0,Y)+ab+W.val().substring(U);W.val(Z);W.focus();var aa=W.get(0);aa.selectionStart=U;aa.selectionEnd=U}Y=U=W=0})}}function G(X){var Z=(X==="topics")?"topic":"post",U="<br/>";var V={topics:X==="topics"?true:false,column:".check-column > input",author:D("td.author"),toggle:D('<a href="#">shortcuts</a>'),help:D(' <span class="wpmt_shortcuts_help">(h) </span>'),stats:D('<span class="wpmt_stats"></span>')};V.check_all=D("thead tr "+V.column+",tfoot tr "+V.column);if(!V.topics){U=" | %shift i% to edit non bozo user profiles only<br/>%z% - go to the next normal profile post | %x% - go to the previous normal profile post<br/>%shift z% - go to the next bozo profile post | %shift x% - go to the previous bozo profile post<br/>"}var W="table.widefat tr.wpmt_current td{border:solid #9f9f9f;border-width:2px 0}table.widefat tr.wpmt_current td.check-column{border-left:2px solid #9f9f9f}table#posts-list tr.wpmt_current td.date,table#topics-list tr.wpmt_current td.freshness{border-right:2px solid #9f9f9f}{border-right:2px solid #9f9f9f}.wpmt_bozo_profile{display:block;margin-top:10px;color:white;text-align:center;background:red}.wpmt_profile_type{padding:4px 6px;border:1px solid red}.wpmt_profile_type.wpmt_green{border:1px solid green}.wpmt_selected,.wpmt_select{background-color: "+j+";}.wpmt_profile_type.wpmt_selected{padding: 5px 7px;border:none;}",Y='%h% - show/hide shortcuts<br/>%d% - loop through Bulk Actions dropdown options<br/>%a% - <span class="wpmt_select">select</span>/deselect all posts<br/>%s% - <span class="wpmt_select">select</span>/deselect current post<br/>%v% - view current post in a new tab<br/>%e% - edit the user profile from the current post in a new tab.<br/>%i% - edit all user profiles from <span class="wpmt_select">selected posts</span> in new tabs.'+U+'%mouse click% - Click in the "Author" column to <span class="wpmt_select">select</span>/deselect a post (also sets the post to current)<br/>'+i;D("head").append('<style type="text/css">'+C+W+"</style>");Y=n+d+Y;Y=(V.topics)?Y.split("post").join(Z):Y;V.shortcuts=D('<p style="display: none;">'+y+v(Y)+"</p>");b.append(V.stats,V.help,V.toggle,u,V.shortcuts);D("body").append(b);D("#bbUserInfo > p").prepend(z);c();o="tr."+f;w="tr:first";S=D("#"+X+"-list tbody tr");h=D("#bbHead");F=S.last();K("#"+Z+"-search-form");A(V);R();B();r()}function p(){var V=D("#user_url");var W={website:V,site_url:V.val(),bozo:D("input#is_bozo"),askimet:D("#elf_not_trusted")};D("head").append('<style type="text/css">'+C+"</style>");var U=d.split("post").join("section")+"%e% - refresh this profile page<br/>"+x+'%w% - remove website url (or add it back)<br/>%z% - select/deselect "This user is a bozo" checkbox<br/>%x% - select/deselect "Akismet Never Trust" checkbox<br/>';L.append(y,u);shortcut_list="<p>"+v(n+U)+"</p>";b.append(L,shortcut_list);D("body").append(b);z.insertBefore(D("#profile-form")).wrap("<p></p>");c();o="#profile-form h3."+f;w="h3.wpmt_section:first";S=D("#profile-form h3");S.addClass("wpmt_section");D("h3:contains('Mailing Lists')").removeClass("wpmt_section");D("h3:contains('Administration')").addClass("wpmt_admin_section");D("label[for='user_url']").append(v(" %(w)%"));D("label[for='is_bozo']").append(v(" %(z)%"));D("label[for='elf_not_trusted']").append(v(" %(x)%"));h=D("#wporg-header");F=D("#wporg-footer");K("#profile-form");K("#head-search > form");g(W);J();R();B();r()}function m(){D("head").append('<style type="text/css">'+C+"</style>");var U=n+"%n% - go to User Activity<br/>";if(e){U+="%e% - open the edit profile page in a new tab<br/>"+x}L.append(y,u);shortcut_list="<p>"+v(U)+"</p>";b.append(L,shortcut_list);D("body").append(b);var V=D(".topicnav").first().find("p");V.css("margin","0 0 .5em");z.insertAfter(V).wrap("<p></p>");c();D.each(["#user-replies","#user-threads"],function(W,X){P(X)});K("#head-search > form");K(".login");o="#useractivity."+f;w=0;S=D("#useractivity");h=D("#wporg-header");F=D("#wporg-footer");if(e){J()}R();B();r()}function t(){var U=".wpmt_profile_selected {background-color: #efeef5;padding: 3px 6px;margin: 3px 0;display: inline-block;}.wpmt_ip-warning{color:red;}";D("head").append('<style type="text/css">'+C+U+"</style>");var W="%e% - open the current post's user profile page in a new tab<br/>"+i;L.append(y,u);shortcut_list="<p>"+v(n+d+W)+"</p>";b.append(L,shortcut_list);D("body").append(b);var V=D(".topicnav").first().find(".bbcrumb");V.css("margin","0 0 .5em");z.insertAfter(V).wrap("<p></p>");c();o="li."+f;w="li:first";S=D(".postitem");K("#postform");K("#head-search > form");K("#tag-form");h=D("#wporg-header");F=S.last();R();B();q();r()}function g(U){D("html").bind("keydown.wpmt",function(Z){if(H!==false){return}var V=I(Z);var Y;if((87===Z.keyCode)&&(1===V)){if(s(U.website)===1){D(o).removeClass(f);Y=S.first();Y.addClass(f);Q(Y);if(U.site_url){if(""===U.website.val()){U.website.val(U.site_url)}else{U.website.val("")}clearTimeout(X);U.website.parents("tr").css("background-color","#FFFFCC");var X=setTimeout(function(){U.website.parents("tr").css("background-color","#FFFFFF")},300)}}}if((Z.keyCode===90||Z.keyCode===88)&&(V===1)){var W=(Z.keyCode===90)?U.bozo:U.askimet;if(W){D(o).removeClass(f);Y=D("h3.wpmt_admin_section").addClass(f);if(s(Y)===1){Q(D(Y));if(W.attr("checked")){W.removeAttr("checked")}else{W.click()}clearTimeout(aa);W.parents("tr").css("background-color","#FFFFCC");var aa=setTimeout(function(){W.parents("tr").css("background-color","#FFFFFF")},300)}}}})}function q(){V();function V(){var Y=S;var X={};var Z={};var W={};Y=Y.filter(function(){var aa=D(this).find(".threadauthor > p > strong").text();if(X[aa]){return false}else{X[aa]=true;return true}});D.each(Y,function(aa,ab){var ac=D(this).find(".post-ip-link").text();if(ac.length){if(Z[ac]){W[ac]=true}else{Z[ac]=true}}});if(D.isEmptyObject(W)){return}S.each(function(){var ab=D(this).find(".post-ip-link");if(s(ab)===1){var aa=ab.text();if(W[aa]){ab.before(D('<span class="wpmt_ip-warning">(DUPLICATE IP)</span><br />'))}}})}S.bind("click.wpmt",function(X){if(X.target.nodeName!=="A"){U();M();D(this).addClass(f);var W=D(this).find(".authortitle a");if(s(W)){W.addClass("wpmt_profile_selected")}}});if(S.length===1){S.first().trigger("click.wpmt")}D("html").bind("keydown.wpmt",function(Z){if(H!==false){return}var X=I(Z);var Y=D(o);if(s(Y)){U();var W=D(Y).find(".authortitle a");if(s(W)){W.addClass("wpmt_profile_selected");if((Z.keyCode===69)&&(X=1)){E(W.attr("href"))}}}else{U()}});function U(){D(".authortitle > a",S).removeClass("wpmt_profile_selected")}D("#yourtaglist").find("a").each(function(){if(D(this).text()==="modlook"){var W=D(this).parents("li");if(s(W)){parent_id=W.attr("id").split("_");if(parent_id[1].length){W.append(D('<a class="wpmt_modlook" href="https://wordpress.org/support/profile/'+parent_id[1]+'" title="modlook tagged by user '+parent_id[1]+'">'+parent_id[1]+"</a>"))}}}})}function A(X){var U;V();D("html").bind("keydown.wpmt",function(ag){if(H!==false){return}var af=I(ag);var ah,Z;if((ag.keyCode===83)&&(af===1)){ah=D(o);if(s(ah)===1){Q(ah);var aa=ah.find(X.column);aa.attr("checked",!aa.attr("checked"));V()}}if((ag.keyCode===86)&&(af===1)){ah=D(o);if(s(ah)){var ak=X.topics?ah.find(".row-title > a:first"):ah.find(".row-actions > a:first");if(s(ak)){if(X.topics){Z=ak.attr("href")}else{Z=(ak.text()==="View")?ak.attr("href"):0}if(Z.length){E(Z)}}}}if((ag.keyCode===68)&&(af===1)){D(".bulk-form select[name=action] > option:selected").removeAttr("selected").next("option").attr("selected","selected")}if((ag.keyCode===65)&&(af===1)){U=(X.check_all.attr("checked"))?"off":"on";W()}if((ag.keyCode===72)&&(af===1)){X.shortcuts.toggle();ah=D(o);if(s(ah)){Q(ah)}}if(k.hasOwnProperty(73)){var ad,aj=[],ai=false;if(!X.topics&&(k.hasOwnProperty(16)&&af===2)){ai=true;ad=D(".wpmt_normal_post").find(".post_selected")}else{if(af===1){ai=true;ad=D(".post_selected")}}if(ai&&s(ad)){ad.each(function(){Z=D(this).children().first("a").attr("href");if(aj.indexOf(Z)===-1){aj.push(Z);E(Z+"/edit")}})}}if((ag.keyCode===69)&&(af===1)){ah=D(o);if(s(ah)===1){Z=ah.find(".wpmt_profile_edit > a").attr("href");if(Z.length){E(Z)}}}if(!X.topics&&(S.length>=1)){if(k.hasOwnProperty(90)||k.hasOwnProperty(88)){var ac=(k.hasOwnProperty(16)&&(af===2))?"bozo":"normal";var al=k.hasOwnProperty(90)?"z":"x",ab=D(".wpmt_"+ac+"_post");if(s(ab)){if(!s(D(o))){if(al==="z"||((ab.length===1)&&al==="x")){ah=ab.first();ah.addClass(f);Q(ah)}}else{if(ab.length===1){var ae=ab.first();S.removeClass(f);ae.addClass(f);Q(ae)}else{var Y;ah=D(o);if(al==="z"){Y=ah.nextAll(".wpmt_"+ac+"_post:first")}if(al==="x"){Y=ah.prevAll(".wpmt_"+ac+"_post:first")}if(s(Y)){S.removeClass(f);Y.addClass(f);Q(Y)}}}}}}});X.check_all.bind("click.wpmt",function(){U=(D(this).attr("checked"))?"on":"off";W()});S.bind("click.wpmt",function(Y){if(Y.target.nodeName!=="A"){D("tbody tr").removeClass(f);D(this).addClass(f)}});D("tbody > tr > "+X.column).bind("click.wpmt",function(Y){V()});X.author.bind("click.wpmt",function(Y){if(Y.target.nodeName!=="A"){V(D(this).parent().attr("id"))}});X.toggle.bind("click.wpmt",function(Y){Y.preventDefault();X.shortcuts.toggle()});u.bind("click.wpmt",function(Y){Y.preventDefault();X.shortcuts.hide()});function W(){X.author.each(function(){var Y=D(this).parent().find(X.column);if(U==="on"){Y.attr("checked",true)}else{Y.attr("checked",false)}});V();U=false}function V(ad){X.stats.empty();var ac=0;X.author.each(function(){var ai=D(this).parent().children(".check-column").css("background-color"),ag=D.trim(D(this).children().first("a").text()),ah=D(this).parent().find(X.column);D(this).css("background",ai);if(!s(D(this).children(".wpmt_profile_edit"))){var af=D("img",D(this).children().first("a")),ae='<br/><span class="wpmt_profile_edit"><a href="'+D(this).children().first("a").attr("href")+'/edit">Edit Profile</a></span>';if(ag.indexOf("(BOZO)")>=0){ag=D.trim(ag.replace("(BOZO)",""));D(this).children().first("a").text(" "+ag);if(af){D(this).children().first("a").prepend(af)}D(this).append('<span class="wpmt_bozo_profile" >BOZO</span>');D(this).parent().addClass("wpmt_bozo_post");++ac}else{D(this).parent().addClass("wpmt_normal_post")}D(this).children().first("a").after(ae)}else{if(s(D(this).children("span.wpmt_bozo_profile"))){++ac}}if(ah.attr("checked")){D(this).attr("style","background: "+j+";");D(this).addClass("post_selected")}else{D(this).css("background",ai);D(this).removeClass("post_selected")}if((typeof(ad)!=="undefined")&&(ad===D(this).parent().attr("id"))){if(ah.attr("checked")){D(this).css("background",ai);ah.attr("checked",false);D(this).removeClass("post_selected")}else{D(this).attr("style","background: "+j+";");ah.attr("checked",true);D(this).addClass("post_selected")}}});var Z=D("tbody > tr").length,ab=D("tbody > tr > "+X.column+":checked").length;if(ab<Z){D(X.check_all).attr("checked",false)}if(ab===Z){D(X.check_all).attr("checked",true)}var Y="";var aa=(X.topics)?"topic":"post";Y+="Current Page: "+Z+" "+aa+((Z===1)?"":"s");if(!X.topics){Y+=' &#10022; <span class="wpmt_profile_type">';Y+=(ac>0)?ac+" bozo"+((ac===1)?"":"s"):"0 bozos";Y+="</span>";Y+=' &#10022; <span class="wpmt_profile_type wpmt_green">';Y+=(Z-ac>0)?(Z-ac)+" normal profile"+(((Z-ac)===1)?"":"s"):"no normal profiles";Y+="</span>"}Y+=' | <span class="wpmt_profile_type wpmt_selected">';Y+=(ab>0)?ab+" "+aa+((ab===1)?"":"s")+" selected":"No "+aa+"s selected";Y+="</span> | ";X.stats.append(Y)}}function J(){var U=D("#profile-menu");var Z;var W;var Y;if(s(U)){Z=U.find("a").filter(function(aa){return D(this).text()==="Edit"})}else{return}if(s(Z)){Z.text("Edit (e)");W=Z.attr("href");var V=D("#userlogin");if(s(V)){Y=T+"/posts.php?forum_id=0&post_author="+V.text();var X=D('<li><a href="'+Y+'">bb-admin (r)</a></li>');Z.parent().after(X)}}if((W.length)||(Y.length)){D("html").bind("keydown.wpmt",function(ab){if(H!==false){return}var aa=I(ab);if((ab.keyCode===69)&&(W.length)){if(aa===1){if(s(D("#profile-form"))){location.reload(true)}else{E(W)}}}if((ab.keyCode===82)&&(Y.length)){if(aa===1){E(Y)}}})}}function R(){var U;D("html").bind("keydown.wpmt",function(X){if(H!==false||(typeof(S)==="undefined")){return}var W=I(X);if(X.keyCode===78||X.keyCode===80){var V=X.keyCode===78?"n":"p";if(!s(D(o))){if((V==="n")&&(W===1)){U=S.first();Q(U);U.addClass(f)}}else{U=D(o);if((V==="n")&&(W===1)){if(s(U.nextAll(w))){U.removeClass(f).nextAll(w).addClass(f);Q(D(o))}else{Q(D(o))}}if((V==="p")&&(W===1)){if(s(U.prevAll(w))){U.removeClass(f).prevAll(w).addClass(f);Q(D(o))}else{U.removeClass(f);if(s(h)&&w){Q(h)}}}}}})}function B(){D("html").bind("keydown.wpmt",function(V){if(H!==false){return}var U=I(V);if((V.keyCode===84)&&(U===1)){if(s(h)){Q(h);if(typeof(S)!=="undefined"){M()}}}if((V.keyCode===66)&&(U===1)){if(s(F)){Q(F);if(typeof(S)!=="undefined"){M();S.last().addClass(f)}}}})}function r(){u.bind("click.wpmt",function(V){V.preventDefault();b.toggle();O=(b.is(":visible"))?"show":"hide";c();var U=D(o);if(s(U)){Q(U)}});D("html").bind("keydown.wpmt",function(V){if(H!==false){return}var U=I(V);if((V.keyCode===77)&&(U===1)){u.trigger("click.wpmt")}})}function Q(V){var W=V.offset().top;var U=65;if(b.is(":visible")){U=b.height();U+=30}else{if((D(V).height()+U)>D(window).height()){U=5}}W=W-U;D("html, body").animate({scrollTop:W},{duration:150})}function c(){if("hide"===O){b.hide();z.text("type m to display the menu")}else{if("show"===O){z.text("type m to hide the menu")}else{O="hide";b.hide();z.text("type m to display the menu")}}}function M(){if(s(S)){S.removeClass(f)}}function K(U){el=D(U);if(s(el)){el.focusin(function(){H=true}).focusout(function(){H=false})}}function I(U){k[U.which]=true;return Object.keys(k).length}function E(U){k={};setTimeout(function(){window.open(U,"_blank")},200)}D(document).bind("keyup.wpmt",function(U){if(k.hasOwnProperty(U.which)){delete k[U.which]}});function P(U){var V=D(U).find("a");if(s(D(V))){D(V).attr("href",function(){var X=this.search;var W=this.protocol+"//"+this.host+this.pathname;var Y=false;if(X){var Z=/view=all/g;if(!Z.test(X)){Y=W+X+"&view=all"}}else{Y=W+"?view=all"}if(Y){return Y+this.hash}return this})}}function v(U){return U.replace(/\%(.*?)\%/g,'<span class="wpmt_shortcut">$1</span>')}function s(U){if(typeof(U)!=="undefined"){return U.length}return 0}N()});